name: Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
      - run: npm ci
      - run: npm run build:prod
      - name: Upload files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          source: "."
          target: "/var/www/ats-application"
          timeout: "120s"
      - name: Remote setup and restart
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            sudo mkdir -p /var/www/ats-application
            sudo chown -R $USER:$USER /var/www/ats-application
            cd /var/www/ats-application
            printf "%s\n" \
              "NODE_ENV=production" \
              "PORT=5000" \
              "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
              "DB_HOST=${{ secrets.DB_HOST }}" \
              "DB_USER=${{ secrets.DB_USER }}" \
              "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
              "DB_NAME=${{ secrets.DB_NAME }}" \
              "REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}" \
              "WHATSAPP_ACCESS_TOKEN=${{ secrets.WHATSAPP_ACCESS_TOKEN }}" \
              "WHATSAPP_PHONE_NUMBER_ID=${{ secrets.WHATSAPP_PHONE_NUMBER_ID }}" \
              "WHATSAPP_VERIFY_TOKEN=${{ secrets.WHATSAPP_VERIFY_TOKEN }}" \
              "WHATSAPP_APP_SECRET=${{ secrets.WHATSAPP_APP_SECRET }}" \
              > .env
            npm ci --production
            command -v pm2 >/dev/null 2>&1 || sudo npm i -g pm2
            pm2 describe ats-application || pm2 start server/index.js --name "ats-application"
            pm2 reload ats-application
            pm2 save
      - name: Health check
        run: curl -fsSL https://www.affinitytaxservices.com/health